<!DOCTYPE html>
<!--suppress HtmlFormInputWithoutLabel, CssUnusedSymbol -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SIM1 VIEWER</title>

    <style>
      html, body {
          height: 100%;
          margin: 0;
      }
      h1, h2, h3, h4, h5, h6, pre { margin: 0 0 .3em 0; }
      body {
          font-family: monospace;
          padding: 8px;
          box-sizing: border-box;
      }

      .dragging { background: cadetblue; }

      main {
          display: flex;
          flex-direction: row;
          width: 100%;
          height: 100%;
          justify-content: space-between;
      }

      #container { min-width: 770px; }

      #controls {
          margin-bottom: 10px;
          padding: 10px;
          border-radius: 10px;
          border: 1px solid #d8d8d8;
      }

      #meta {
          margin-bottom: 10px;
          padding: 15px;
          border-radius: 10px;
          border: 1px solid #d8d8d8;
      }
      #gene-rep {
          width: 100%;
          height: 25px;
          display: flex;
      }
      #gene-rep span {
          display: inline-block;
          flex: 1;
          background-color: #d8d8d8;
      }
      #gene-rep span[x-value="1"] { background-color: #444; }

      #reports {
          padding: 15px;
          border-radius: 10px;
          border: 1px solid #d8d8d8;
      }

      #agents {
          flex: 1;
          min-width: 130px;
          padding: 10px 15px 7px 5px;
          overflow-y: scroll;
          border-radius: 10px;
          border: 1px solid #d8d8d8;
      }
      #agents ol { padding-inline-start: 60px; }
      #agents li:hover {
          background: rgba(0, 0, 0, .1);
          cursor: pointer;
      }

      #agents li.selected {
          background: rgba(0, 0, 0, .2);
      }

      #modal {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          box-sizing: border-box;
          border-radius: 15px;
          background: rgba(0, 0, 0, .1);
          backdrop-filter: grayscale(100%) blur(1px);
          -webkit-backdrop-filter: grayscale(100%) blur(1px);
          z-index: 9999;

          flex: none;
          justify-content: center;
          align-items: center;

          display: none;
      }

      /*noinspection CssUnusedSymbol*/
      #modal.show { display: flex; }
      #modal::after {
          content: 'â•³';
          position: absolute;
          top: 20px;
          right: 25px;
          font-weight: bolder;
          font-size: 26px;
          text-shadow: 0 0 10px rgba(0, 0, 0, 1);
          cursor: pointer;
      }
      #modal main {
          position: absolute;
          width: 800px;
          height: 400px;
          padding: 20px;
          background: white;
          box-shadow: 0 0 20px rgba(0, 0, 0, .5);
          border: 1px solid #bbb;
          border-radius: 10px;
      }
    </style>
</head>
<body>
    <main>
        <div id="container"></div>

        <div style="flex-direction: column; display: flex; justify-content: space-between">
            <div id="meta"></div>

            <div id="reports">
                <h4>Reports:</h4>
                <button id="report-pop-growth">Population Growth</button>
                <button id="report-gen-growth">Gen Growth</button>
            </div>
        </div>

        <div style="flex-direction: column; display: flex">
            <div id="controls">
                <button id="prev">< Prev</button>
                <input type="number" id="epoch" value="0" style="width: 4em">
                <button id="next">Next ></button>
                <br>
                <button id="play">Play</button>
                <select id="speed">
                    <option value="1">x1</option>
                    <option value="2">x2</option>
                    <option value="4">x4</option>
                    <option value="8">x8</option>
                    <option value="10">x10</option>
                    <option value="30">x30</option>
                    <option value="60">x60</option>
                    <option value="100">x100</option>
                </select>
                <br>
                <label><input type="checkbox" id="loop" /> Loop</label>
            </div>

            <div id="agents">
                <h4>Agents:</h4>
                <form id="agents-filters" onsubmit="return false">
                    <label for="filter-gen">Gen:</label>
                    <input type="number" name="Gen" id="filter-gen" min="1" max="9999">
                </form>
                <ol></ol>
            </div>
        </div>
    </main>

    <div id="modal"><main></main></div>

    <script src="lib/chart.js"></script>
  <script>
    const SvgRectSize = 5;
    const
        GeneMaskColor = 0x00000FFF,
        GeneMaskSight = 0x0000F000,
        GeneMaskSpeed = 0x000F0000;

    function getAgentColor(a) {
        let r = ((a.dna&GeneMaskColor&0xF00) >> 8) * 16;
        let g = ((a.dna&GeneMaskColor&0x0F0) >> 4) * 16;
        let b = (a.dna&GeneMaskColor&0x00F) * 16;

        return `rgb(${r}, ${g}, ${b})`;
    }

    function svg(e) {
      if (renderCache[e] !== undefined) return renderCache[e];

      let s = `<svg xmlns="http://www.w3.org/2000/svg"
        width="${svgConf.canvas.width}px"
        height="${svgConf.canvas.height}px"
        viewBox="0 0 ${svgConf.canvas.width} ${svgConf.canvas.height}">`;

      s += `<text y="24px" font-size="24px">${label(e)}</text>`;
      s += `<rect
        width="${svgConf.borderBox.width}px"
        height="${svgConf.borderBox.height}px"
        x="${svgConf.borderBox.offsetX}" y="${svgConf.borderBox.offsetY}"
        fill="none" stroke="#000" stroke-width="${svgConf.borderBox.borderWidth}" />`;

      const xOffset = svgConf.borderBox.offsetX + svgConf.borderBox.borderWidth;
      const yOffset = svgConf.borderBox.offsetY + svgConf.borderBox.borderWidth;
      for (let agent of data.epoch[e].population) {
        s += `<rect
            x="${agent.x * SvgRectSize + xOffset}"
            y="${agent.y * SvgRectSize + yOffset}"
            width="${SvgRectSize}px"
            height="${SvgRectSize}px"
            stroke="none"
            fill="${getAgentColor(agent)}"
            data-id="${agent.id}" />`;
      }

      renderCache[e] = s + '</svg>';
      return renderCache[e];
    }

    function label(e) {
        const ts = data.epoch[e].time / 1000;
        return `Epoch #${e} - Population: ${data.epoch[e].population.length} (${ts < 1 ? data.epoch[e].time+'ms' : ts.toFixed(3)+'s'})`;
    }

    let data;
    let svgConf;
    let renderCache = [];
    let highlightAgents = [];
    let filters = {};
    let currentEpoch = 0;
    let playing = false;
    let playerLoop = false;
    let playerSpeed = 1;
    let playerID; // IntervalID

    function loadJSON(_data) {
        data = _data;
        renderCache = [];
        svgConf = {
            canvas: {
                width:  data.size*SvgRectSize + SvgRectSize*4,
                height: data.size*SvgRectSize + 40 + SvgRectSize*4,
            },
            borderBox: {
                width:       data.size*SvgRectSize + SvgRectSize*2,
                height:      data.size*SvgRectSize + SvgRectSize*2,
                offsetX:     SvgRectSize,
                offsetY:     SvgRectSize + 40,
                borderWidth: SvgRectSize,
            },
        };

        configureFilters();
        renderEpoch(0);
    }

    function configureFilters() {
        resetFilters();

        let gen = document.getElementById('filter-gen');
        gen.setAttribute('max', data.epoch[data.total_epochs-1].population.sort((a, b) => b.gen - a.gen)[0].gen);
    }

    function readFilters() {
        let form    = document.getElementById('agents-filters');
        let entries = new FormData(form).entries();

        filters = {};
        for (let f of entries) {
            if (form.querySelector(`[name="${f[0]}"]`).getAttribute('type') === 'number') {
                filters[f[0]] = parseFloat(f[1]);
            } else {
                filters[f[0]] = f[1];
            }
        }

        filterAgents();
    }

    function resetFilters() {
        let form = document.getElementById('agents-filters');
        form.reset();

        filters = {};
        highlightAgents = [];

        renderHighlightedAgents();
    }

    function filterAgents() {
        if (Object.keys(filters).length === 0) return;

        data.epoch[currentEpoch].population.forEach((agent) => {
            let selected = true;
            for (let f of Object.keys(filters)) {
                if (agent[f] !== filters[f]) {
                    selected = false;
                    break;
                }
            }

            document.querySelector(`#agents li[data-id="${agent.id}"]`).classList.toggle('selected', selected);
        });

        highlightAgents = [].map.call(document.querySelectorAll('#agents .selected'), el => el.getAttribute('data-id'));
        renderHighlightedAgents();
    }

    function renderAgentList(e) {
        const aList = document.querySelector('#agents ol');
        aList.innerHTML = '';

        for (let agent of data.epoch[e].population) {
            const li = document.createElement('li');
            li.setAttribute('data-id', agent.id);
            li.innerText = agent.id;
            if (highlightAgents.indexOf(agent.id) !== -1) {
                li.classList.add('selected');
            }
            aList.append(li);
        }
    }

    function renderHighlightedAgents() {
        const svg = document.querySelector('#container svg');
        if (!svg) return;

        if (highlightAgents.length < 1) {
            svg.querySelectorAll('rect[data-id]').forEach(r => r.removeAttribute('fill-opacity'));
            renderMetadata(null);
        } else {
            svg.querySelectorAll('rect[data-id]').forEach(r => r.setAttribute('fill-opacity', '.15'));
            highlightAgents.forEach(id => svg.querySelector(`rect[data-id="${id}"]`).removeAttribute('fill-opacity'));
        }

        if (highlightAgents.length > 0) {
            let agent = data.epoch[currentEpoch].population.find(a => a.id === highlightAgents[highlightAgents.length-1]);

            renderMetadata({
                info: agent,
                properties: {
                    Color: getAgentColor(agent),
                    Sight: (agent.dna&GeneMaskSight) >> 12,
                    Speed: (agent.dna&GeneMaskSpeed) >> 16,
                },
                prevAction: data.epoch[currentEpoch].actions[agent.id] || null,
                nextAction: currentEpoch+1 >= data.epoch.length ? null :
                    data.epoch[currentEpoch+1].actions[agent.id],
            });
        }
    }

    function toAbsString(num, radix) {
        if (num < 0) {
            num += 0xFFFFFFFF+1;
        }
        return num.toString(radix).toUpperCase();
    }

    function renderMetadata(data) {
        if (data === null) {
            document.getElementById('meta').innerHTML = '';
            return;
        }

        document.getElementById('meta').innerHTML = '<pre>'+JSON.stringify(data, null, 2)+'</pre>' +
            (data.info && data.info.dna ?
            '<div id="gene-rep">' +
                toAbsString(data.info.dna, 2).split('').map(b => `<span x-value="${b}"></span>`).join('') +
            '</div>' : '');
    }

    function renderEpoch(e) {
        currentEpoch = e;
        document.getElementById('epoch').value = e;

        document.getElementById('container').innerHTML = svg(e);

        renderAgentList(e);
        filterAgents();
        renderHighlightedAgents();
    }
    function nextEpoch() {
        if (currentEpoch+1 <= data.total_epochs) renderEpoch(currentEpoch+1);
    }
    function previousEpoch() {
        if (currentEpoch-1 >= 0) renderEpoch(currentEpoch-1);
    }
    function playNextEpoch() {
        if (currentEpoch < data.total_epochs) {
            nextEpoch();
        } else if (playerLoop) {
            renderEpoch(0);
        } else {
            playing = false;
            document.getElementById('play').innerText = 'Play';
            clearInterval(playerID);
            playerID = null;
        }
    }

    document.querySelector('body').addEventListener('dragenter', () => {
        document.body.classList.add('dragging');
    });
    document.querySelector('body').addEventListener('dragleave', () => {
        document.body.classList.remove('dragging');
    });
    document.querySelector('body').addEventListener('dragover', (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
    });
    document.querySelector('body').addEventListener('drop', (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
        document.body.classList.remove('dragging');

        if (evt.dataTransfer.files.length < 1 || evt.dataTransfer.files[0].type !== 'application/json') {
            return alert('unsupported file');
        }

        const reader = new FileReader();
        reader.addEventListener('load', () => {
            loadJSON(JSON.parse(reader.result));
        });
        reader.readAsText(evt.dataTransfer.files[0]);
    });

    document.getElementById('epoch').addEventListener('change', (evt) => {
        renderEpoch(evt.target.value);
    });
    document.getElementById('next').addEventListener('click', () => {
        if (currentEpoch < data.total_epochs) {
            nextEpoch();
        } else if (confirm("Last epoch. Restart playback?")) {
            renderEpoch(0);
        }
    });
    document.getElementById('prev').addEventListener('click', previousEpoch);
    document.getElementById('play').addEventListener('click', function() {
        playing = !playing;
        if (playing) {
            this.innerText = 'Pause';
            if (currentEpoch === data.total_epochs) renderEpoch(0);
            playerID = setInterval(playNextEpoch, 1000/playerSpeed);
        } else {
            this.innerText = 'Play';
            clearInterval(playerID);
        }
    });
    document.getElementById('speed').addEventListener('change', function() {
        playerSpeed = this.value;
        if (playing) {
            clearInterval(playerID);
            playerID = setInterval(playNextEpoch, 1000/playerSpeed);
        }
    });
    document.getElementById('loop').addEventListener('change', function() {
        playerLoop = this.checked;
    });

    document.querySelector('#agents ol').addEventListener('click', (evt) => {
        if (evt.target.tagName !== 'LI') return;
        evt.target.classList.toggle('selected');
        highlightAgents = [].map.call(document.querySelectorAll('#agents .selected'), el => el.getAttribute('data-id'));
        renderHighlightedAgents();
    });
    document.getElementById('container').addEventListener('click', (evt) => {
        if (evt.target.tagName !== 'rect') return;
        const id = evt.target.getAttribute('data-id');
        document.querySelector(`#agents li[data-id="${id}"]`).classList.toggle('selected');
        highlightAgents = [].map.call(document.querySelectorAll('#agents .selected'), el => el.getAttribute('data-id'));
        renderHighlightedAgents();
    });
    document.getElementById('agents-filters').addEventListener('change', readFilters);

    document.getElementById('modal').addEventListener('click', (evt) => {
        if (evt.target.matches('#modal')) evt.target.classList.remove('show');
    });
    document.getElementById('report-pop-growth').addEventListener('click', () => {
        const modal = document.getElementById('modal');
        const container = modal.querySelector('main');
        container.innerHTML = '';

        const canvas = document.createElement('canvas');
        container.append(canvas);

        let dataset = data.epoch.map(epoch => epoch.population.length);

        new Chart(canvas, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Population',
                    data: dataset,
                }],
                labels: dataset.map((_, i) => i),
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: "Epoch" } },
                    y: { title: { display: true, text: "Population" } },
                },
                interaction: {
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: "Population Growth",
                    },
                },
            },
        });

        modal.classList.add('show');
    });
    document.getElementById('report-gen-growth').addEventListener('click', () => {
        const modal = document.getElementById('modal');
        const container = modal.querySelector('main');
        container.innerHTML = '';

        const canvas = document.createElement('canvas');
        container.append(canvas);

        let counted = data.epoch[0].state.map(a => a.ID);
        let accGens = [];
        let dataset = [];

        data.epoch.forEach((epoch, e) => {
            let agents = epoch.state
                .filter(a => !counted.includes(a.ID));

            counted = counted.concat(agents.map(a => a.ID));

            let gens = agents.reduce(
                (gens, agent) => {
                    gens[agent.Gen] = gens[agent.Gen] ? gens[agent.Gen]+1 : 1;
                    return gens;
                }, []
            );

            gens = gens.map((pop, g) => {
                let newBirths = pop - (accGens[g] || 0);
                accGens[g] = (accGens[g] || 0) + newBirths;
                return newBirths
            }).filter(pop => pop > 0);

            gens = gens.map((newBirths, gen) => ({
                x: e,
                y: gen,
                r: newBirths,
            }));

            dataset = dataset.concat(gens);
        });

        new Chart(canvas, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'New births',
                    data: dataset,
                }],
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: "Epoch" } },
                    y: { title: { display: true, text: "Generation" } },
                },
                plugins: {
                    title: {
                        display: true,
                        text: "Generational Growth",
                    },
                },
            },
        });

        modal.classList.add('show');
    });
  </script>
</body>
</html>
